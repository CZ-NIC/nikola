#!/usr/bin/python
#
# Nikola - firewall log sender (a part of www.turris.cz project)
# Copyright (C) 2013 CZ.NIC, z.s.p.o. (http://www.nic.cz/)
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation,
# Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301  USA
#


import base64
import json
import optparse
import os
import subprocess
import zlib

from nikola.logger import get_logger
from nikola.rpc_wrapper import WrappedServer
from nikola.syslog_parser import parse_syslog


if __name__ == '__main__':

    # Parse the command line options
    optparser = optparse.OptionParser("usage: %prog [options] server_addr")
    optparser.add_option("-l", "--log-file", dest='syslog_file',
                         default='/var/log/iptables', type='string',
                         help='specify the syslog file to be parsed')

    optparser.add_option("-m", "--max", dest='max', default=1000, type='int',
                         help='max record count to be sent')

    optparser.add_option("-f", "--date-format", dest='date_format',
                         default='%Y-%m-%dT%H:%M:%S', type='string',
                         help='specify the syslog date format')

    optparser.add_option("-r", "--log-rotate-conf", dest='logrotate_conf',
                         default='/etc/logrotate.d/nikola', type='string',
                         help='specify the log rotate config to be triggered')

    optparser.add_option("-d", "--debug", dest='debug', action='store_true',
                         default=False, help='use debug output')

    optparser.add_option("-w", "--wan-interface", dest='wan',
                         default=None, type='string',
                         help='specify the wan interface')

    (options, args) = optparser.parse_args()

    if len(args) != 1:
        optparser.error("incorrect number of arguments")

    logger = get_logger(options.debug)

    server_addr = args[0]
    syslog_file = options.syslog_file
    max_packet_count = options.max
    syslog_date_format = options.date_format
    logrotate_conf = options.logrotate_conf
    wan = options.wan

    try:

        server = WrappedServer(server_addr)

        if not wan:

            # Get the wan interface using uci
            try:
                wan = subprocess.check_output(('uci', 'get', 'network.wan.ifname')).strip()
            except (subprocess.CalledProcessError, OSError):
                wan = None

        if os.path.exists(syslog_file) and wan:
            # Parse syslog
            parsed = parse_syslog(syslog_file, wan, syslog_date_format)

            #logrotete the logs
            output = subprocess.check_output(
                ('/usr/sbin/logrotate', '-s', '/tmp/logrotate-nikola.state', logrotate_conf, )
            )
            logger.debug(("logrotate output: %s" % output))

        else:
            # To file to parse means no records
            parsed = []

        logger.info(("Records parsed: %d" % len(parsed)))
        logger.debug(("First record: %s" % parsed[0]) if parsed else 'No records')
        if max_packet_count < len(parsed):
            msg = "To many data to send in one batch. (%d/%d)" % (len(parsed),
                                                                  max_packet_count)
            logger.error(msg)
            logger.debug(server.init_session())
            logger.debug(server.api_turris_cz.report_error(msg))
        else:
            # comporess the logs
            compressed = base64.b64encode(zlib.compress(json.dumps(parsed), 1))
            logger.debug(server.init_session())
            logger.info(server.api_turris_cz.firewall.store_logs(compressed))

    except Exception, e:
        logger.error(("Exception thrown: %s" % e))
